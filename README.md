# YOLO

YOLO helps you deploy high-availability PHP applications on AWS.

The CLI tool takes care of provisioning and configuring all required resources on AWS, coupled with build and deployment
commands to deploy applications to production from your local machine or CI pipeline.

___

## Disclaimer

YOLO is designed for PHP developers who want to manage AWS using an infrastructure-as-code approach, using plain-old PHP
rather than CloudFormation / Terraform / K8s / Elastic Beanstalk / <some-other-exotic-alternative>.

While YOLO has been battle-tested on apps serving millions of requests per day, it is not supposed to be a
set-and-forget solution for busy apps, but rather allows you to grow and adapt your infrastructure as requirements
change over time.

Within the Laravel ecosystem there are several high quality commercial alternatives like Forge, Vapor and Cloud, which
require less working knowledge of AWS.

It goes without saying, but YOLO at your own risk.

## Prerequisites

Before getting started, ensure you have [AWS CLI](https://aws.amazon.com/cli/) installed.

You'll also need access to an AWS account, and some knowledge of AWS services.

### Permissions & Authentication

YOLO uses AWS profiles for authentication.

Profiles are stored in `~/.aws/credentials` for authentication. You'll need to set a
`YOLO_{ENVIRONMENT}_AWS_PROFILE` in the app `.env` file to point to the correct profile; eg.

```bash
YOLO_PRODUCTION_AWS_PROFILE=my-project-profile
```

Once configured, future operations will authenticate using this profile.

You will need wide-ranging AWS credentials to provision everything required by YOLO; administrative permissions are
recommended.

For CI environments like GitHub Actions, `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` are used instead. Ensure that
any access keys provided in CI are using least-privileged scope.

## Installation

### Install With Composer

```bash
composer require codinglabsau/yolo
```

## Usage

The entry point to the YOLO CLI is `vendor/bin/yolo` or `yolo` if you have `./vendor/bin` in your path.

To get up and running, you'll need to complete the following steps:

1. Setup authentication and update your .env to point to the correct AWS profile
2. Initialise the YOLO manifest file
3. Run the install command
4. Run the deploy command

After the initial install, you can simply add `yolo deploy <environment>` to your CI pipeline to deploy your app.

### `yolo install`

The install command is the first command to run after installing YOLO. It does the following things:

- initialises the yolo.yml file in the app with a boilerplate production environment
- adds some entries to `.gitignore`
- provisions various resources on AWS
- builds and registers an Amazon Machine Image for EC2s
-

After initialising, you can customise the `yolo.yml` manifest file to suit your app's requirements.

### Sync Commands

After initialising YOLO manifest, all remaining infrastructure commands are prefixed with `sync:`.

The sync commands are:

- `yolo sync:network <environment>` prepares the VPC, subnets, security groups and SSH keys
- `yolo sync:domain <environment>` prepares domain resources (standard apps only)
- `yolo sync:landlord <environment>` prepares landlord resources (multitenancy apps only)
- `yolo sync:tenant <environment>` prepares tenant resources (multitenancy apps only)
- `yolo sync:compute <environment>` prepares the compute resources
- `yolo sync:ci <environment>` prepares the continuous integration pipeline

### `yolo ami:create <environment>`

With all low-level resource provisioned, the next step is to create an AMI for EC2s. All server types will utilise this
AMI.

### `yolo prepare <environment>`

Prepares autoscaling groups, EC2 launch template and alarms.

### `yolo env:push <environment>`

Prior to building the environment, you'll need to create `.env.<environment>` followed by `yolo env:push <environment>`.

### `yolo build <environment>`

The build command takes care of building a deployment-ready directory in `./yolo`.

### `yolo deploy <environment>`

The build command takes care of building and deploying. You can run this locally, or in CI. The deploy command will call
the build step for you if a local build does not exist.

## Full yolo.yml example

This is a complete yolo.yml file, showing default values where applicable.

Note that some keys are intentionally omitted from the stub generated by `yolo init`.

```yaml
name: codinglabs

environments:
  production:
    aws:
      region: ap-southeast-2
      bucket:
      artefacts-bucket:
      cloudfront:
      alb:
      security-group-id:
      transcoder: false
      autoscaling:
        web:
        queue:
        scheduler:
      ec2:
        instance-type: t3.small
        instance-profile:
        octane: true
        key-pair:

    build:
      - composer install --no-cache --no-interaction --optimize-autoloader --no-progress --classmap-authoritative --no-dev
      - npm ci
      - npm run build
      - rm -rf package-lock.json resources/js resources/css node_modules database/seeders database/factories resources/seeding

    domain: codinglabs.com.au
    www: false
    pulse-worker: false
    mysqldump: false

    deploy:
      - php artisan migrate --force

    deploy-all:
      - php artisan optimize
```

## Development

To debug or add features to YOLO, it is recommended to symlink to the local repository.

Add this to composer.json with the path to the local repository:

```json
    // ...

"repositories": [
{
"type": "path",
"url": "/Users/username/code/yolo"
}
],
```

To call yolo from the app you are debugging, you'll need to tell yolo the path to the app. Set the `YOLO_BASE_PATH`
environment to the root of the app as follows:

```bash
YOLO_BASE_PATH=$(pwd) yolo
```

## Credits

- [Steve Thomas](https://github.com/stevethomas)
- [All Contributors](https://github.com/codinglabsau/yolo/contributors)

## License

Proprietary.
